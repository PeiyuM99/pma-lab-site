---
import { getCollection } from 'astro:content';
import PageLayout from '../layouts/PageLayout.astro';

const allPeople = (await getCollection('people')).sort((a, b) => a.data.order - b.data.order);

const groups = [
  { key: 'pi', label: 'PI' },
  { key: 'phd', label: 'PhD' },
  { key: 'master', label: 'Master' },
  { key: 'undergrad', label: 'Undergraduate' },
];

function groupKey(role: string) {
  const r = role.toLowerCase();
  if (r.includes('pi') || r.includes('principal investigator')) return 'pi';
  if (r.includes('phd')) return 'phd';
  if (r.includes('master')) return 'master';
  if (r.includes('undergrad') || r.includes('bachelor')) return 'undergrad';
  return 'phd';
}

const grouped = Object.fromEntries(groups.map((g) => [g.key, allPeople.filter((p) => groupKey(p.data.role) === g.key)]));
const base = import.meta.env.BASE_URL;
const toAssetUrl = (p: string) => (p.startsWith('http') ? p : `${base}${p.replace(/^\//, '')}`);
---

<PageLayout title="People">
  <section class="people-shell">
    <h1>People</h1>

    <div class="people-layout">
      <aside class="sidebar">
        <h3>Categories</h3>
        <ul>
          {groups.map((g) => (
            <li><a href={`#${g.key}`}>{g.label}</a></li>
          ))}
        </ul>
      </aside>

      <section class="content">
        {groups.map((g) => (
          <section id={g.key} class="group-block">
            <h2>{g.label}</h2>
            {grouped[g.key].length === 0 ? (
              <p class="empty">No members yet.</p>
            ) : (
              <div class="cards-grid">
                {grouped[g.key].map((p) => (
                  <article class="person-card">
                    <h3>{p.data.name}</h3>

                    <div class="person-head">
                      {p.data.avatar && <img class="avatar" src={toAssetUrl(p.data.avatar)} alt={`${p.data.name} avatar`} />}
                      <div class="person-meta">
                        <p><strong>{p.data.role}</strong></p>
                        {p.data.email && <p><strong>Email:</strong> <a href={`mailto:${p.data.email}`}>{p.data.email}</a></p>}
                        {p.data.website && <p><strong>Website:</strong> <a href={p.data.website} target="_blank">{p.data.website}</a></p>}
                      </div>
                    </div>

                    {p.data.interests && <p><strong>Research interests:</strong> {p.data.interests}</p>}
                    {p.data.bio && <p><strong>Bio:</strong> {p.data.bio}</p>}

                    {p.data.education && p.data.education.length > 0 && (
                      <div>
                        <p><strong>Education</strong></p>
                        <ul>
                          {p.data.education.map((e) => (
                            <li>{e.degree}, {e.school}, {e.year}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {p.data.recruitment && <p><strong>Open positions / collaboration:</strong> {p.data.recruitment}</p>}
                    {p.data.office && <p><strong>Office:</strong> {p.data.office}</p>}
                  </article>
                ))}
              </div>
            )}
          </section>
        ))}
      </section>
    </div>
  </section>
</PageLayout>

<style>
  :global(main) {
    width: min(1800px, calc(100% - 2rem));
    max-width: 1800px;
  }

  .people-shell {
    width: 100%;
    margin: 0 auto;
  }

  .people-layout {
    display: grid;
    grid-template-columns: 260px minmax(0, 1fr);
    gap: 2rem;
    align-items: start;
  }

  .sidebar {
    position: sticky;
    top: 1rem;
    align-self: start;
    border: 1px solid #e8e8e8;
    border-radius: 10px;
    padding: 1rem;
    background: #fff;
  }

  .sidebar ul {
    margin: 0;
    padding-left: 1rem;
  }

  .group-block {
    margin-bottom: 2rem;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
    gap: 1.25rem;
  }

  .person-card {
    border: 1px solid #e6e6e6;
    border-radius: 10px;
    padding: 1.35rem 1.5rem;
    background: #fff;
  }

  .person-head {
    display: grid;
    grid-template-columns: 110px minmax(0, 1fr);
    gap: 1rem;
    align-items: stretch;
    margin-bottom: 0.9rem;
  }

  .avatar {
    width: 110px;
    height: 110px;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid #d9e1ee;
  }

  .person-meta {
    height: 110px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .person-meta p {
    margin: 0;
  }

  .person-card p,
  .person-card li {
    line-height: 1.75;
  }

  .empty {
    color: #666;
  }

  @media (max-width: 900px) {
    :global(main) {
      width: calc(100% - 1rem);
    }
    .people-layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      position: static;
    }
    .person-head {
      grid-template-columns: 1fr;
    }
    .person-meta {
      height: auto;
      gap: 0.35rem;
    }
  }
</style>
