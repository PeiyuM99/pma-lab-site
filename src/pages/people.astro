---
import { getCollection } from 'astro:content';
import PageLayout from '../layouts/PageLayout.astro';

const allPeople = (await getCollection('people')).sort((a, b) => a.data.order - b.data.order);

const groups = [
  { key: 'pi', label: 'PI' },
  { key: 'phd', label: 'PhD' },
  { key: 'master', label: 'Master' },
  { key: 'undergrad', label: 'Undergraduate' },
];

function groupKey(role: string) {
  const r = role.toLowerCase();
  if (r.includes('pi') || r.includes('principal investigator')) return 'pi';
  if (r.includes('phd')) return 'phd';
  if (r.includes('master')) return 'master';
  if (r.includes('undergrad') || r.includes('bachelor')) return 'undergrad';
  return 'phd';
}

const grouped = Object.fromEntries(groups.map((g) => [g.key, allPeople.filter((p) => groupKey(p.data.role) === g.key)]));
---

<PageLayout title="People">
  <section class="people-shell">
    <h1>People</h1>

    <div class="people-layout">
      <aside class="sidebar">
        <h3>Categories</h3>
        <ul>
          {groups.map((g) => (
            <li><a href={`#${g.key}`}>{g.label}</a></li>
          ))}
        </ul>
      </aside>

      <section class="content">
        {groups.map((g) => (
          <section id={g.key} class="group-block">
            <h2>{g.label}</h2>
            {grouped[g.key].length === 0 ? (
              <p class="empty">No members yet.</p>
            ) : (
              <div class="cards-grid">
                {grouped[g.key].map((p) => (
                  <article class="person-card">
                    <h3>{p.data.name}</h3>
                    <p><strong>{p.data.role}</strong></p>
                    {p.data.email && <p>Email: <a href={`mailto:${p.data.email}`}>{p.data.email}</a></p>}
                    {p.data.website && <p>Website: <a href={p.data.website} target="_blank">{p.data.website}</a></p>}
                    {p.data.interests && <p>Research interests: {p.data.interests}</p>}
                    {p.data.bio && <p>Bio: {p.data.bio}</p>}

                    {p.data.education && p.data.education.length > 0 && (
                      <div>
                        <p><strong>Education</strong></p>
                        <ul>
                          {p.data.education.map((e) => (
                            <li>{e.degree}, {e.school}, {e.year}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {p.data.recruitment && <p>Open positions / collaboration: {p.data.recruitment}</p>}
                    {p.data.office && <p>Office: {p.data.office}</p>}
                  </article>
                ))}
              </div>
            )}
          </section>
        ))}
      </section>
    </div>
  </section>
</PageLayout>

<style>
  :global(main) {
    width: min(1800px, calc(100% - 2rem));
    max-width: 1800px;
  }

  .people-shell {
    width: 100%;
    margin: 0 auto;
  }

  .people-layout {
    display: grid;
    grid-template-columns: 260px minmax(0, 1fr);
    gap: 2rem;
    align-items: start;
  }

  .sidebar {
    position: sticky;
    top: 1rem;
    align-self: start;
    border: 1px solid #e8e8e8;
    border-radius: 10px;
    padding: 1rem;
    background: #fff;
  }

  .sidebar ul {
    margin: 0;
    padding-left: 1rem;
  }

  .group-block {
    margin-bottom: 2rem;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .person-card {
    border: 1px solid #e6e6e6;
    border-radius: 10px;
    padding: 1.25rem 1.4rem;
    background: #fff;
  }

  .empty {
    color: #666;
  }

  @media (max-width: 900px) {
    :global(main) {
      width: calc(100% - 1rem);
    }
    .people-layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      position: static;
    }
  }
</style>
